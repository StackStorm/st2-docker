
## Building images

```
docker build -t stackstorm/stackstorm:xenial .

docker build -t stackstorm/stackstorm:xenial-2.9.1 --build-arg ST2_VERSION=2.9.1 .
docker build -t stackstorm/stackstorm:xenial-2.9.0 --build-arg ST2_VERSION=2.9.0 .
docker build -t stackstorm/stackstorm:xenial-2.8.1 --build-arg ST2_VERSION=2.8.1 .

docker build -t stackstorm/stackstorm:xenial-dev --build-arg ST2_REPO=unstable --build-arg NODE_REPO=node_8.x .
```

## Running `st2-self-test`

```
apt-get -y install uuid-runtime
export ST2_AUTH_TOKEN=$(st2 auth $ST2_USER -p $ST2_PASSWORD -t)
/opt/stackstorm/st2/bin/st2-self-check
```

## Insecure keys

Introduce "insecure" keys in following places.

- st2 datastore key
- SSL self-signed cert for nginx/st2web
- ssh key for stanley user

The idea is like "insecure ssh key" of Vagrant. We save the pre-generated keys in this repo and copy them into the image.

This helps those keys to be consistent among images of different versions/builds. Previously, those are dynamically generated during the docker build process, and it depends on the environment wheter it changes or not because of docker layer caching. This unstableness is considered harmful in both dev/ci and production use case. Leaving the default keys in production also makes the installation vulnerable.

Unlike vagrant, these insecure keys are not replaced at runtime by default. For dev/ci use case, the default insecure key should just work fine. But for production usage, it is strongly recommended to replace them by the one that user generated by their own. This should be mentioned in main README.md to warn users.

## New envvars

- `ST2_DISABLE_MISTRAL`
    - Controls whether to enable Mistral or not. If any value is set, following steps will be skipped during the container startup.
        - Modification of `/etc/mistral/mistral.conf` to set PostgreSQL/RabbitMQ connection configs
        - Invocation of `mistral-db-manage` for schema migration/data population
        - Configuration of mistral-api, mistral-server process under supervisord: this means that those processes can't be started with `supervisorctl start`, even not be listed at all with `supervisorctl list`
    - default: (not set)

- `ST2_ENABLE_ST2CHATOPS`
    - Controls whether to start `st2chatops` or not. If any value is set, supervisord will launch st2chatops. If not, it will even skip the configuration of supervisord for `st2chatops`, so that it prevents from `st2ctl reload` or `st2ctl restart` or any similar command to accidentaly starts `st2chatops` process
    - default: (not set)

- `ST2_ENABLE_SSHD`
    - Controls whether to start sshd daemon or not. If any value is set, supervisord will launch sshd. **Only meant for testing purpose.** Need to be enabled when you run `st2-self-check`, since it uses some `core.remote` actions during the tests
    - default: (not set)

